all: init smolsh

# Remove any builtin targets...
.SUFFIXES:

# Make sure we know where to get nolibc
ifndef NOLIBCDIR
$(error Please pass NOLIBCDIR with the path to your copy of nolibc (tools/include/nolibc/ in the linux source))
endif

# Make sure we know where the toolchain is
ifndef CROSS_COMPILE
$(error Please pass CROSS_COMPILE with the prefix of you toolchain)
endif

CC=$(CROSS_COMPILE)gcc
BFDLD=$(CROSS_COMPILE)ld.bfd
STRIP=$(CROSS_COMPILE)strip

COPTS=-m68000 \
	-g \
	-ffunction-sections \
	-fdata-sections \
	-nostdlib \
	-std=c99 \
	-DNOLIBC_STATIC_PIE \
	-Os \
	-I_build/headers/include



%.o: %.c
	$(CC) $(COPTS) \
	 -include $(NOLIBCDIR)/nolibc.h \
	 -c -o $@ $<

init: init.o
	$(CC) $(COPTS) $^ -o $@

smolsh: smolsh.o
	$(CC) $(COPTS) $^ -o $@

define ELF_BUILD
$(1).elf.dbg: $(1).o
	$$(BFDLD) \
		--gc-sections \
		--print-gc-sections \
		--no-dynamic-linker \
		--hash-style=gnu \
		-pie $$^ -o $$@

$(1).elf: $(1).elf.dbg
	$$(STRIP) $$< -o $$@
endef

$(eval $(call ELF_BUILD,init))
$(eval $(call ELF_BUILD,smolsh))

.PHONY: clean
clean:
	rm -f init smolsh *.o *.gdb
